<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KMG Komagene Kraliyet Ailesi</title>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<style>
body{
margin:0;
background:radial-gradient(circle,#111,#000);
color:white;
font-family:Arial;
text-align:center;
}
h1{
color:gold;
margin-top:20px;
}
#chat{
height:300px;
overflow:auto;
border:2px solid gold;
margin:20px;
padding:10px;
background:#111;
border-radius:10px;
text-align:left;
}
input{
padding:10px;
margin:5px;
width:220px;
border-radius:8px;
border:1px solid #333;
background:#0e0e0e;
color:#fff;
}
button{
padding:10px 18px;
background:gold;
border:none;
cursor:pointer;
font-weight:bold;
margin:5px;
border-radius:8px;
}
#micBtn{
width:60px;
height:60px;
border-radius:50%;
background:red;
color:white;
font-size:22px;
}
.system{
color:gold;
}
</style>
</head>

<body>

<h1>ðŸ‘‘ KMG Komagene Kraliyet Ailesi ðŸ‘‘</h1>

<button onclick="guestLogin()">Misafir GiriÅŸ</button>
<br>

<input id="username" placeholder="Ä°smin">
<input id="room" placeholder="Oda Kodu">
<button onclick="joinRoom()">Odaya KatÄ±l</button>

<div id="chat"></div>

<input id="message" placeholder="Mesaj yaz">
<button onclick="sendMessage()">GÃ¶nder</button>

<br>
<button id="micBtn" onclick="toggleMic()">ðŸŽ¤</button>

<script>
const socket = io("https://kmg-server-xz9a.onrender.com", {
  transports: ["websocket"],
  secure: true
});

let micEnabled = false;
let stream = null;
let joined = false;

window.onload = function(){
try{
const speech = new SpeechSynthesisUtterance("HoÅŸgeldin kral");
speech.lang = "tr-TR";
speechSynthesis.speak(speech);
}catch(e){}
};

function addLine(html){
const chat = document.getElementById("chat");
chat.innerHTML += html;
chat.scrollTop = chat.scrollHeight;
}

function guestLogin(){
let randomId = "Misafir" + Math.floor(Math.random()*9999);
document.getElementById("username").value = randomId;
}

function joinRoom(){
const username = document.getElementById("username").value.trim();
const room = document.getElementById("room").value.trim();

if(!username || !room){
alert("Ä°sim ve oda kodu gir kral ðŸ‘‘");
return;
}

socket.emit("join-room", room, username);
joined = true;

addLine(`<p class="system">ðŸ‘‘ ${username} odaya katÄ±ldÄ±</p>`);
}

function sendMessage(){
if(!joined){
alert("Ã–nce odaya katÄ±l kral ðŸ‘‘");
return;
}

const msgEl = document.getElementById("message");
const msg = msgEl.value.trim();
if(!msg) return;

socket.emit("send-message", msg);
msgEl.value="";
}

socket.on("receive-message", data=>{
addLine(`<p><b>${escapeHtml(data.user)}:</b> ${escapeHtml(data.text)}</p>`);
});

function escapeHtml(str){
return String(str ?? "")
.replaceAll("&","&amp;")
.replaceAll("<","&lt;")
.replaceAll(">","&gt;")
.replaceAll('"',"&quot;")
.replaceAll("'","&#039;");
}

async function toggleMic(){
try{
if(!micEnabled){
stream = await navigator.mediaDevices.getUserMedia({audio:true});
document.getElementById("micBtn").style.background="green";
micEnabled=true;
}else{
if(stream) stream.getTracks().forEach(t=>t.stop());
document.getElementById("micBtn").style.background="red";
micEnabled=false;
}
}catch(e){
alert("Mikrofon izni verilemedi kral ðŸ‘‘");
}
}
</script>

</body>
</html>
